<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Serviços Construção Civil</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>

<style>
body {
    font-family: Arial;
    max-width: 600px;
    margin: auto;
    padding: 20px;
    background: #f4f4f4;
}

.card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

input, textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

button {
    padding: 8px 12px;
    font-size: 14px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 5px;
}

button:hover {
    background: #005fcc;
}

button.apagar {
    background: #dc3545;
}

button.apagar:hover {
    background: #a71d2a;
}

button.editar {
    background: #28a745;
}

button.editar:hover {
    background: #1e7e34;
}

#agenda {
    margin-top: 20px;
    padding: 10px;
    background: #eee;
    border-radius: 6px;
}

.ocupado {
    color: red;
    font-weight: bold;
}

.servicoItem {
    margin-bottom: 10px;
}
</style>
</head>
<body>

<h2 style="text-align:center">Serviço de Construção Civil</h2>

<div class="card">
<label>Cliente:</label>
<input id="cliente" type="text">

<label>Data do Serviço:</label>
<input id="data" type="date" onchange="verificarData()">

<label>Descrição do Serviço:</label>
<textarea id="descricao"></textarea>

<label>Materiais:</label>
<textarea id="materiais"></textarea>

<label>Mão de Obra (€):</label>
<input id="maoobra" type="number">

<label>Materiais (€):</label>
<input id="valormateriais" type="number">

<button onclick="adicionarServico()">Adicionar/Atualizar Serviço</button>

<div id="agenda">
    <h3>Agenda de Serviços</h3>
    <ul id="listaServicos"></ul>
</div>
</div>

<script>
let servicos = JSON.parse(localStorage.getItem('servicos')) || [];
let editIndex = null;

function diaSemana(dataStr) {
    const dias = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const dataObj = new Date(dataStr);
    return dias[dataObj.getDay()];
}

function atualizarAgenda() {
    servicos.sort((a,b) => new Date(a.data) - new Date(b.data));
    
    const lista = document.getElementById('listaServicos');
    lista.innerHTML = '';
    servicos.forEach((s,index) => {
        const li = document.createElement('li');
        li.className = "servicoItem";
        li.innerHTML = `<span class="ocupado">${s.data} (${diaSemana(s.data)})</span> - ${s.cliente}
                        <button onclick="baixarPDF(${index})">PDF</button>
                        <button class="editar" onclick="editarServico(${index})">Editar</button>
                        <button class="apagar" onclick="apagarServico(${index})">Apagar</button>`;
        lista.appendChild(li);
    });
}

function verificarData() {
    const dataSelecionada = document.getElementById('data').value;
    if (editIndex === null && servicos.some(s => s.data === dataSelecionada)) {
        alert('Esta data já está ocupada! Escolha outra.');
        document.getElementById('data').value = '';
    }
}

function adicionarServico() {
    const cliente = document.getElementById('cliente').value;
    const data = document.getElementById('data').value;
    const descricao = document.getElementById('descricao').value;
    const materiais = document.getElementById('materiais').value;
    const maoobra = Number(document.getElementById('maoobra').value);
    const valormateriais = Number(document.getElementById('valormateriais').value);

    if(!cliente || !data) {
        alert('Preencha o nome do cliente e a data!');
        return;
    }

    if (editIndex === null && servicos.some(s => s.data === data)) {
        alert('Esta data já está ocupada!');
        return;
    }

    if(editIndex !== null) {
        servicos[editIndex] = {cliente, data, descricao, materiais, maoobra, valormateriais};
        editIndex = null;
    } else {
        servicos.push({cliente, data, descricao, materiais, maoobra, valormateriais});
    }

    localStorage.setItem('servicos', JSON.stringify(servicos));
    atualizarAgenda();

    document.getElementById('cliente').value = '';
    document.getElementById('data').value = '';
    document.getElementById('descricao').value = '';
    document.getElementById('materiais').value = '';
    document.getElementById('maoobra').value = '';
    document.getElementById('valormateriais').value = '';
}

// --- FUNÇÃO ATUALIZADA PARA ANDROID ---
function baixarPDF(index) {
    const s = servicos[index];
    const total = s.maoobra + s.valormateriais;

    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("Fatura de Serviço - Construção Civil", 10, 15);
    doc.setFontSize(12);
    doc.text(`Cliente: ${s.cliente}`, 10, 35);
    doc.text(`Data: ${s.data} (${diaSemana(s.data)})`, 10, 45);
    doc.text("Descrição do Serviço:", 10, 65);
    doc.text(s.descricao, 10, 75);
    doc.text("Materiais:", 10, 100);
    doc.text(s.materiais, 10, 110);
    doc.text(`Mão de Obra: €${s.maoobra.toFixed(2)}`, 10, 135);
    doc.text(`Materiais: €${s.valormateriais.toFixed(2)}`, 10, 145);
    doc.text(`Total: €${total.toFixed(2)}`, 10, 160);

    // ABRIR EM NOVA ABA → FUNCIONA EM ANDROID
    const blobUrl = doc.output('bloburl');
    window.open(blobUrl, '_blank');
}

function editarServico(index) {
    const s = servicos[index];
    document.getElementById('cliente').value = s.cliente;
    document.getElementById('data').value = s.data;
    document.getElementById('descricao').value = s.descricao;
    document.getElementById('materiais').value = s.materiais;
    document.getElementById('maoobra').value = s.maoobra;
    document.getElementById('valormateriais').value = s.valormateriais;
    editIndex = index;
}

function apagarServico(index) {
    if(confirm("Tem certeza que deseja apagar este serviço?")) {
        servicos.splice(index,1);
        localStorage.setItem('servicos', JSON.stringify(servicos));
        atualizarAgenda();
    }
}

atualizarAgenda();
</script>

</body>
</html>
